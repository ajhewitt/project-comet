#!/usr/bin/env bash
set -euo pipefail
ENV_NAME=${ENV_NAME:-comet}
PYVER=${PYVER:-3.11}
if ! micromamba env list | awk '{print $1}' | grep -qx "$ENV_NAME"; then
  micromamba create -y -n "$ENV_NAME" -c conda-forge python="$PYVER" pip healpy namaster cfitsio fftw numpy
fi
micromamba run -n "$ENV_NAME" python -m pip install -U pip
micromamba run -n "$ENV_NAME" pip install -e ".[dev]"
micromamba run -n "$ENV_NAME" ruff format --check .
micromamba run -n "$ENV_NAME" ruff check .
micromamba run -n "$ENV_NAME" pytest -q -m "not local"
COMET_ALLOW_DIRTY=1 micromamba run -n "$ENV_NAME" python -m comet.cli demo

# --- smoke: quick artifact check for CI/dev ---
if [[ "${1:-}" == "smoke" ]]; then
  set -euo pipefail

  # run the quick pipeline
  chmod +x scripts/pipeline_quick.sh scripts/pipeline_check.sh
  ./scripts/pipeline_quick.sh
  ./scripts/pipeline_check.sh
fi
